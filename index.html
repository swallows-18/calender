<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スケジュール管理アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the application */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f0f2f6;
        }
        /* Style for the schedule indicator dot */
        .schedule-dot {
            height: 8px;
            width: 8px;
            background-color: #28a745; /* green */
            border-radius: 50%;
            display: inline-block;
            margin-left: auto;
        }
        /* Custom scrollbar for the sidebar schedule list */
        .schedule-list::-webkit-scrollbar {
            width: 6px;
        }
        .schedule-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .schedule-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .schedule-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Ensure calendar cells have a minimum height */
        .calendar-day {
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        /* Basic button styling */
        .btn {
            @apply w-full px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors;
        }
        .btn-secondary {
            @apply bg-gray-600 hover:bg-gray-700 focus:ring-gray-500;
        }
        .btn-danger {
             @apply bg-red-600 hover:bg-red-700 focus:ring-red-500;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="p-4 md:p-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">📅 スケジュール管理アプリ</h1>

        <div class="flex flex-col md:flex-row gap-6">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-full md:w-1/4 lg:w-1/5 bg-white p-4 rounded-lg shadow-md h-fit"></aside>

            <!-- Main Content -->
            <main class="w-full md:w-3/4 lg:w-4/5 flex flex-col lg:flex-row gap-6">
                <!-- Calendar -->
                <div id="calendar-container" class="w-full lg:w-2/3 bg-white p-4 rounded-lg shadow-md"></div>
                <!-- Schedule Editor -->
                <div id="editor-container" class="w-full lg:w-1/3 bg-white p-4 rounded-lg shadow-md h-fit"></div>
            </main>
        </div>
    </div>

    <script type="module">
        // --- 定数定義 (Constants) ---

        const WEATHER_CODE_TO_EMOJI = {
            "100": "☀️", "101": "🌤️", "102": "🌦️", "103": "🌨️", "104": "🌨️", "105": "🌨️",
            "106": "🌨️", "107": "🌨️", "108": "🌨️", "110": "☀️", "111": "🌤️", "112": "🌧️",
            "113": "🌧️", "114": "🌧️", "115": "🌨️", "116": "🌨️", "117": "🌨️", "118": "🌨️",
            "119": "🌨️", "120": "🌨️", "121": "🌨️", "122": "🌨️", "123": "☀️", "124": "☀️",
            "125": "☀️", "126": "☀️", "127": "☀️", "128": "☀️", "130": "☀️", "131": "☀️",
            "132": "☀️", "140": "🌧️", "160": "🌨️", "170": "🌨️", "181": "🌨️", "200": "☁️",
            "201": "🌥️", "202": "🌧️", "203": "🌧️", "204": "🌧️", "205": "🌧️", "206": "🌧️",
            "207": "🌧️", "208": "🌧️", "209": "🌧️", "210": "☁️", "211": "🌥️", "212": "🌧️",
            "213": "🌧️", "214": "🌧️", "215": "🌨️", "216": "🌨️", "217": "🌨️", "218": "🌨️",
            "219": "🌨️", "220": "🌨️", "221": "🌨️", "222": "🌨️", "223": "☁️", "224": "☀️",
            "225": "☀️", "226": "☀️", "227": "☀️", "228": "🌧️", "229": "🌧️", "230": "🌧️",
            "231": "☀️", "240": "🌧️", "250": "🌨️", "260": "🌨️", "270": "🌨️", "281": "🌨️",
            "300": "🌧️", "301": "🌧️", "302": "🌧️", "303": "🌧️", "304": "🌧️", "306": "🌧️",
            "308": "🌧️", "309": "🌧️", "311": "🌧️", "313": "🌧️", "314": "🌧️", "315": "🌧️",
            "316": "🌧️", "317": "🌧️", "320": "☁️", "321": "☁️", "322": "🌨️", "323": "☀️",
            "324": "☀️", "325": "☀️", "326": "🌧️", "327": "🌧️", "328": "🌧️", "329": "🌧️",
            "340": "🌨️", "350": "🌨️", "361": "🌨️", "371": "🌨️", "400": "❄️", "401": "❄️",
            "402": "❄️", "403": "❄️", "405": "❄️", "406": "❄️", "407": "❄️", "409": "❄️",
            "411": "❄️", "413": "❄️", "414": "❄️", "415": "❄️", "416": "❄️", "417": "❄️",
            "420": "❄️", "421": "❄️", "422": "❄️", "423": "❄️", "425": "❄️", "426": "❄️",
            "427": "❄️"
        };

        const AREA_CODES = {
            "札幌": "016000", "仙台": "040000", "東京": "130000", "名古屋": "230000",
            "大阪": "270000", "広島": "340000", "福岡": "400000", "那覇": "471000",
        };
        
        const DATA_KEY = "schedule_data";

        // --- アプリケーションの状態 (Application State) ---
        const state = {
            currentDate: new Date(),
            selectedDate: new Date(),
            schedules: {}, // { 'YYYY-MM-DD': 'memo' }
            weatherData: {}, // { 'YYYY-MM-DD': 'code' }
            holidays: {}, // { 'YYYY-MM-DD': 'name' }
            selectedAreaCode: '130000', // Default to Tokyo
            holidaysCache: {} // Cache for holiday data by year
        };

        // --- DOM要素 (DOM Elements) ---
        const sidebarEl = document.getElementById('sidebar');
        const calendarContainerEl = document.getElementById('calendar-container');
        const editorContainerEl = document.getElementById('editor-container');

        // --- データ永続化 (Data Persistence using localStorage) ---

        function saveSchedules() {
            try {
                localStorage.setItem(DATA_KEY, JSON.stringify(state.schedules));
                return true;
            } catch (e) {
                console.error("Failed to save schedules:", e);
                // Optionally show an error to the user
                return false;
            }
        }

        function loadSchedules() {
            try {
                const data = localStorage.getItem(DATA_KEY);
                return data ? JSON.parse(data) : {};
            } catch (e) {
                console.error("Failed to load schedules:", e);
                return {};
            }
        }
        
        // --- API通信 (API Fetching) ---
        
        async function fetchWeeklyWeather(areaCode) {
            const url = `https://www.jma.go.jp/bosai/forecast/data/forecast/${areaCode}.json`;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                
                if (!data || !data[0]?.timeSeries?.[0]) return {};

                const timeSeries = data[0].timeSeries[0];
                const dates = timeSeries.timeDefines || [];
                const weatherCodes = timeSeries.areas?.[0]?.weatherCodes || [];

                const weatherMap = {};
                for (let i = 0; i < dates.length; i++) {
                    const dateStr = dates[i].split('T')[0];
                    weatherMap[dateStr] = weatherCodes[i];
                }
                return weatherMap;
            } catch (e) {
                console.warn("Failed to fetch weather data:", e);
                return {}; // Return empty on failure
            }
        }

        async function fetchHolidays(year) {
            if (state.holidaysCache[year]) {
                return state.holidaysCache[year];
            }
            const url = `https://holidays-jp.github.io/api/v1/${year}/date.json`;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                state.holidaysCache[year] = data;
                return data;
            } catch (e) {
                console.warn("Failed to fetch holiday data:", e);
                return {};
            }
        }
        
        // --- UI描画 (UI Rendering) ---

        function renderSidebar() {
            const sortedSchedules = Object.entries(state.schedules)
                .filter(([, memo]) => memo)
                .sort(([dateA], [dateB]) => new Date(dateA) - new Date(dateB));

            sidebarEl.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-semibold mb-2 text-gray-700">設定</h3>
                        <label for="area-select" class="block text-sm font-medium text-gray-600">地域を選択</label>
                        <select id="area-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            ${Object.keys(AREA_CODES).map(name => `<option value="${AREA_CODES[name]}" ${state.selectedAreaCode === AREA_CODES[name] ? 'selected' : ''}>${name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2 text-gray-700">カレンダー移動</h3>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button id="prev-month-btn" class="btn btn-secondary">◀️ 前月</button>
                            <button id="next-month-btn" class="btn btn-secondary">翌月 ▶️</button>
                        </div>
                        <button id="today-btn" class="btn">今月に戻る</button>
                    </div>
                    <div>
                         <h3 class="text-lg font-semibold mb-2 text-gray-700">保存済みの予定一覧</h3>
                         <div class="schedule-list max-h-60 overflow-y-auto space-y-2 pr-2">
                            ${sortedSchedules.length > 0 ? sortedSchedules.map(([date, memo]) => `
                                <div class="text-sm">
                                    <p class="font-semibold text-gray-600">${date}</p>
                                    <p class="text-gray-500 whitespace-pre-wrap pl-2">${memo}</p>
                                </div>
                            `).join('') : '<p class="text-sm text-gray-500">保存された予定はありません。</p>'}
                         </div>
                    </div>
                </div>
            `;
            addSidebarEventListeners();
        }
        
        function renderCalendar() {
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth(); // 0-indexed

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const lastDayOfMonth = lastDay.getDate();
            
            // 0 (Sun) to 6 (Sat), adjust to 0 (Mon) to 6 (Sun)
            const startDayOfWeek = (firstDay.getDay() + 6) % 7; 

            const weekdays = ["月", "火", "水", "木", "金", "土", "日"];
            
            let html = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">${year}年 ${month + 1}月</h2>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center font-semibold text-gray-600">
                    ${weekdays.map(day => `<div>${day}</div>`).join('')}
                </div>
                <div class="grid grid-cols-7 gap-1 mt-1">
            `;
            
            // Add blank days for the first week
            for (let i = 0; i < startDayOfWeek; i++) {
                html += `<div class="bg-gray-50 rounded-lg"></div>`;
            }

            // Add days of the month
            for (let day = 1; day <= lastDayOfMonth; day++) {
                const d = new Date(year, month, day);
                const dateStr = toYYYYMMDD(d);
                const weekday = d.getDay(); // 0=Sun, 6=Sat

                const isToday = toYYYYMMDD(new Date()) === dateStr;
                const holidayName = state.holidays[dateStr];
                const hasSchedule = state.schedules[dateStr];
                const weatherEmoji = WEATHER_CODE_TO_EMOJI[state.weatherData[dateStr]] || '';

                let dayColor = 'text-gray-800';
                if (holidayName || weekday === 0) dayColor = 'text-red-500'; // Sunday or Holiday
                else if (weekday === 6) dayColor = 'text-blue-500'; // Saturday

                html += `
                    <div class="calendar-day border ${isToday ? 'border-blue-500' : 'border-gray-200'} rounded-lg p-1.5 bg-white">
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                ${hasSchedule ? '<span class="schedule-dot mt-1.5"></span>' : '<span></span>'}
                                <p class="font-bold text-right ${dayColor}">${day}</p>
                            </div>
                            ${holidayName ? `<p class="text-xs text-right text-red-500 -mt-1">${holidayName}</p>` : ''}
                            ${weatherEmoji ? `<p class="text-2xl text-right mt-1">${weatherEmoji}</p>` : ''}
                        </div>
                        <button data-date="${dateStr}" class="select-day-btn w-full text-xs px-2 py-1 mt-1 text-white bg-gray-400 hover:bg-gray-500 rounded transition-colors">選択</button>
                    </div>
                `;
            }
            html += `</div>`; // Close grid
            calendarContainerEl.innerHTML = html;
            addCalendarEventListeners();
        }

        function renderEditor() {
            const selectedStr = toYYYYMMDD(state.selectedDate);
            const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][state.selectedDate.getDay()];
            const currentMemo = state.schedules[selectedStr] || "";

            editorContainerEl.innerHTML = `
                <div class="space-y-3">
                    <h3 class="text-lg font-semibold text-gray-700">📝 ${selectedStr} (${dayOfWeek}) の予定・日記</h3>
                    <textarea id="memo-area" class="w-full h-40 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500" placeholder="予定や日記をここに入力...">${currentMemo}</textarea>
                    <div class="flex gap-2">
                        <button id="save-btn" class="btn flex-1">💾 保存</button>
                        <button id="delete-btn" class="btn btn-danger flex-1">🗑️ 削除</button>
                    </div>
                    <div id="editor-feedback" class="text-sm text-green-600"></div>
                </div>
            `;
            addEditorEventListeners();
        }

        // --- イベントリスナー (Event Listeners) ---

        function addSidebarEventListeners() {
            document.getElementById('area-select').addEventListener('change', async (e) => {
                state.selectedAreaCode = e.target.value;
                state.weatherData = await fetchWeeklyWeather(state.selectedAreaCode);
                renderCalendar();
            });
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                state.currentDate.setMonth(state.currentDate.getMonth() - 1);
                updateApp();
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                state.currentDate.setMonth(state.currentDate.getMonth() + 1);
                updateApp();
            });
            document.getElementById('today-btn').addEventListener('click', () => {
                state.currentDate = new Date();
                state.selectedDate = new Date();
                updateApp();
            });
        }
        
        function addCalendarEventListeners() {
            calendarContainerEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('select-day-btn')) {
                    const dateStr = e.target.dataset.date;
                    // JS Date constructor parses YYYY-MM-DD as UTC, so add time to handle it as local
                    state.selectedDate = new Date(dateStr + 'T00:00:00');
                    renderEditor();
                }
            });
        }

        function addEditorEventListeners() {
            const feedbackEl = document.getElementById('editor-feedback');
            document.getElementById('save-btn').addEventListener('click', () => {
                const memo = document.getElementById('memo-area').value;
                const selectedStr = toYYYYMMDD(state.selectedDate);
                state.schedules[selectedStr] = memo;
                if (saveSchedules()) {
                    feedbackEl.textContent = '保存しました！';
                    setTimeout(() => feedbackEl.textContent = '', 2000);
                    renderCalendar();
                    renderSidebar();
                } else {
                    feedbackEl.style.color = 'red';
                    feedbackEl.textContent = '保存に失敗しました。';
                }
            });
            document.getElementById('delete-btn').addEventListener('click', () => {
                const selectedStr = toYYYYMMDD(state.selectedDate);
                if (state.schedules[selectedStr]) {
                    delete state.schedules[selectedStr];
                    if (saveSchedules()) {
                        feedbackEl.textContent = '削除しました！';
                        setTimeout(() => feedbackEl.textContent = '', 2000);
                        document.getElementById('memo-area').value = '';
                        renderCalendar();
                        renderSidebar();
                    } else {
                        feedbackEl.style.color = 'red';
                        feedbackEl.textContent = '削除に失敗しました。';
                    }
                } else {
                    feedbackEl.style.color = 'orange';
                    feedbackEl.textContent = 'この日には保存された予定がありません。';
                    setTimeout(() => feedbackEl.textContent = '', 2000);
                }
            });
        }

        // --- ヘルパー関数 (Helper Functions) ---
        function toYYYYMMDD(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // --- 初期化と更新 (Initialization and Update) ---
        async function updateApp() {
            const year = state.currentDate.getFullYear();
            // Fetch holidays for the current year if not already cached
            if (!state.holidaysCache[year]) {
                state.holidays = await fetchHolidays(year);
            } else {
                state.holidays = state.holidaysCache[year];
            }
            // Weather data is fetched on area change or initial load, can be refreshed here if needed
            renderSidebar();
            renderCalendar();
            renderEditor();
        }

        async function init() {
            // 1. Load data from localStorage
            state.schedules = loadSchedules();
            
            // 2. Set initial dates
            state.currentDate = new Date();
            state.selectedDate = new Date();

            // 3. Fetch external data
            const areaCode = document.getElementById('area-select')?.value || state.selectedAreaCode;
            state.selectedAreaCode = areaCode;
            
            const [weatherData, holidaysData] = await Promise.all([
                fetchWeeklyWeather(areaCode),
                fetchHolidays(state.currentDate.getFullYear())
            ]);
            state.weatherData = weatherData;
            state.holidays = holidaysData;

            // 4. Render the entire application
            updateApp();
        }

        // --- アプリケーション起動 (Start Application) ---
        init();

    </script>
</body>
</html>
